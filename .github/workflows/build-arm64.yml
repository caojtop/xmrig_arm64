name: Auto Build XMRig ARM64 (cron + manual)

# 每6小时检查一次官方最新 release（可改成 '0 3 * * *' 每天凌晨3点）
on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:   # 手动触发

jobs:
  build-arm64:
    runs-on: self-hosted   # 你的 ARM64 自托管 runner
    steps:
      - name: Prevent apt/dpkg/man-db deadlocks (ARM64 lifesaver)
        run: |
          # 解锁 apt/dpkg
          sudo killall -9 apt apt-get dpkg || true
          sudo rm -f /var/lib/dpkg/lock* /var/cache/apt/archives/lock || true
          sudo dpkg --configure -a || true

          # 永别 1049h25l（man-db 无限循环）
          sudo killall -9 man mandb || true
          sudo chmod -x /usr/bin/mandb /usr/bin/man || true   # 禁用触发器，不会影响正常使用

      # 2. 清理工作区（self-hosted 必备）
      - name: Clean workspace
        run: |
          rm -rf ./* ./.??* || true

      # 3. 获取官方最新 tag
      - name: Get official latest tag
        id: latest
        run: |
          LATEST=$(curl -s https://api.github.com/repos/xmrig/xmrig/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
          echo "latest_tag=$LATEST" >> $GITHUB_OUTPUT
          echo "Official latest release: $LATEST"

      # 4. 检查你自己的仓库是否已经存在这个 tag 的 release（已构建过就跳过）
      - name: Check if already built
        id: check
        run: |
          if gh release view ${{ steps.latest.outputs.latest_tag }} --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "already_built=true" >> $GITHUB_OUTPUT
            echo "✓ ARM64 package already exists for ${{ steps.latest.outputs.latest_tag }}, skipping build."
          else
            echo "already_built=false" >> $GITHUB_OUTPUT
            echo "✗ No ARM64 package yet → will build ${{ steps.latest.outputs.latest_tag }}"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          
      - name: Install dependencies
        if: steps.check.outputs.already_built == 'false'
        run: |
          git clone --depth 1 --branch ${{ steps.latest.outputs.latest_tag }} https://github.com/xmrig/xmrig.git .
          sudo apt update
          sudo apt install -y \
            git build-essential cmake automake libtool autoconf wget
  
      - name: Cache xmrig dependencies
        id: cache-deps                     # 给这一步加个 id
        if: steps.check.outputs.already_built == 'false'
        uses: actions/cache@v4
        with:
          path: scripts/deps
          key: xmrig-deps-${{ runner.os }}-${{ hashFiles('scripts/build_deps.sh') }}
  
      - name: Build dependencies
        if: steps.check.outputs.already_built == 'false' && steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd scripts
          ./build_deps.sh
  
      - name: Configure (CMake for ARM64)
        if: steps.check.outputs.already_built == 'false'
        run: |
          mkdir -p build
          cd build
          cmake .. -DXMRIG_DEPS=scripts/deps
  
      - name: Build xmrig
        if: steps.check.outputs.already_built == 'false'
        run: |
          cd build
          make -j$(nproc)
  
      - name: Archive binary
        if: steps.check.outputs.already_built == 'false'
        env:
          TAG: ${{ steps.latest.outputs.latest_tag }}
        run: |
          cd build
          tar -czf xmrig-${TAG#v}-linux-static-arm64.tar.gz xmrig
          sha256sum xmrig-${TAG#v}-linux-static-arm64.tar.gz > SHA256SUMS
          echo "FILENAME=xmrig-${TAG#v}-linux-static-arm64.tar.gz" >> $GITHUB_ENV

      # === 修复 tag 问题的关键步骤 ===
      - name: Prepare for correct tag creation
        if: steps.check.outputs.already_built == 'false'
        env:
          TAG: ${{ steps.latest.outputs.latest_tag }}
        run: |
          # 获取当前（官方仓库）的 commit hash
          OFFICIAL_COMMIT=$(git rev-parse HEAD)
          echo "Official commit hash for $TAG: $OFFICIAL_COMMIT"
          
          # 设置 git 配置
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # 在本地仓库中创建正确的 tag
          git tag -f "$TAG" "$OFFICIAL_COMMIT"
          
          # 推送 tag 到你的仓库
          # 注意：我们推送的是当前目录的代码，这正好是官方仓库的正确版本
          git push --force https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git "$TAG"
          echo "Tag $TAG has been force-updated to commit $OFFICIAL_COMMIT"
  
      - name: Create GitHub Release and Upload Artifact
        if: steps.check.outputs.already_built == 'false'
        env:
          TAG: ${{ steps.latest.outputs.latest_tag }}
          GH_TOKEN: ${{ github.token }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: ARM64 Build - ${{ env.TAG }}
          body: Automated ARM64 build for XMRig $TAG (real ARM64 hardware + crypto extensions)
          files: |
            build/${{ env.FILENAME }}
            build/SHA256SUMS
